# Feature Specification: Historical AI Form Analysis Results

**Feature Branch**: `010-form-analysis-history`  
**Created**: 2026-01-30  
**Status**: Draft  
**Input**: User description: "en el analisis de IA de los formularios, yo puedo generar varios analisis de un mismo formualarios, que son guardado en cache, lo que busco es ver esos resultados en una lista como su fuera un reporte historico del formulario"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Persist AI Analysis (Priority: P1)

As an admin, after generating an AI analysis for a form, I want it to be saved automatically in the database so that it's not lost when the session ends or cache is cleared.

**Why this priority**: Core functionality needed to build a history. Without persistence, history cannot exist across sessions.

**Independent Test**: Generate an AI analysis, refresh the page/clear localStorage, and verify the analysis still exists in the system.

**Acceptance Scenarios**:

1. **Given** I am on the form results page, **When** I click "Analizar con IA", **Then** the analysis is generated and stored in the database.
2. **Given** an analysis was previously generated, **When** I return to the form, **Then** I can see the previously stored result.

---

### User Story 2 - View Analysis History List (Priority: P2)

As an admin, I want to see a list of all previous AI analyses for a specific form template, including the score and date of generation.

**Why this priority**: Directly addresses the user's request for a "reporte hist√≥rico" list.

**Independent Test**: Navigate to a form template, click on "Historical Reports", and see a table/list of all past analyses.

**Acceptance Scenarios**:

1. **Given** multiple analyses have been generated for a form, **When** I view the history list, **Then** I see all entries ordered by date (newest first).
2. **Given** a list of historical reports, **When** I click on one, **Then** the full analysis content is displayed.

---

### User Story 3 - Compare Historical Results (Priority: P3)

As an admin, I want to see a summary of scores across historical reports to see trends or variations.

**Why this priority**: Enhances the "history" value by providing context on how results are changing.

**Independent Test**: View the history list and verify that scores and percentages are clearly visible for comparison.

**Acceptance Scenarios**:

1. **Given** the history list, **When** I scan the entries, **Then** I can easily compare the score percentage of different analysis runs.

---

### Edge Cases

- **Empty History**: What happens when a form has no previous analyses? (System should show a friendly "No hay reportes previos" message).
- **Deleted Form**: What happens to reports if the form template is deleted/renamed? (Reports should remain associated with the original ID or be purged appropriately).
- **Failed Generation**: How does the system handle an AI generation failure in terms of history? (Failed attempts should not be saved to history).

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST persist every successfully generated AI form analysis in the Turso database.
- **FR-002**: System MUST store the analysis text, total score, total possible score, percentage, and timestamp.
- **FR-003**: System MUST provide an endpoint to retrieve the history of analyses for a given `form_id`.
- **FR-004**: System MUST include a UI entry point in the administrator forms view to access the history.
- **FR-005**: System MUST display historical reports in a list or table, showing at least the date and the score/percentage.
- **FR-006**: System MUST allow opening any historical report to view its full Markdown content.

### Key Entities *(include if feature involves data)*

- **FormAnalysis**: Represents a single AI analysis run.
    - `id`: Unique identifier.
    - `form_id`: Reference to the form template.
    - `analysis_text`: The Markdown content generated by AI.
    - `score`: Total score obtained in that run.
    - `total_possible`: Max score possible for the form.
    - `percentage`: Percentage of affinity.
    - `created_at`: Date and time of generation.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Admins can access the history of a form in under 2 clicks from the main forms list.
- **SC-002**: Previously generated analyses are preserved even after clearing browser site data.
- **SC-003**: 100% of successfully generated analyses are recorded in the history database.
- **SC-004**: Loading the history list for a form takes less than 1 second for up to 50 records.
